name: Build Meson (Procursus Roothide)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-meson:
    runs-on: macos-14
    env:
      CACHE_PATH: ${{ github.workspace }}/__procursus_cache
      XCODE_ROOT: /Applications/Xcode_15.2.app
      MEMO_TARGET: iphoneos-arm64-roothide
      IPHONEOS_DEPLOYMENT_TARGET: 15.0
      PATH: /opt/procursus/bin:/opt/procursus/sbin:/usr/bin:/bin:/usr/sbin:/sbin

    steps:
      - name: Checkout Procursus repo
        uses: actions/checkout@v4

      - name: Restore Procursus cache
        uses: actions/cache@v3
        id: procursus-cache
        with:
          path: ${{ env.CACHE_PATH }}
          key: procursus

      - name: Copy cached Procursus if available
        if: steps.procursus-cache.outputs.cache-hit == 'true'
        run: |
          mkdir -p ${{ env.CACHE_PATH }}/procursus/var/cache/apt/archives/partial \
            ${{ env.CACHE_PATH }}/procursus/var/lib/apt/lists/partial
          sudo rsync -aWlHh --inplace ${{ env.CACHE_PATH }}/procursus /opt

      - name: Clone libroothide and build symredirect
        run: |
          git clone https://github.com/ProcursusTeam/libroothide.git
          cd libroothide
          bash symredirect-build.sh
          symredirect || echo "symredirect test completed"

      - name: Prepare Procursus tools if not cached
        if: steps.procursus-cache.outputs.cache-hit != 'true'
        run: |
          chmod +x ${{ github.workspace }}/build_tools/prepare_github_runner.sh
          ${{ github.workspace }}/build_tools/prepare_github_runner.sh

      - name: Add Procursus to PATH
        run: |
          echo "/opt/procursus/bin" >> $GITHUB_PATH
          echo "/opt/procursus/sbin" >> $GITHUB_PATH
          echo "CPATH=$CPATH:/opt/procursus/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$LIBRARY_PATH:/opt/procursus/lib" >> $GITHUB_ENV

      - name: Ensure make is linked
        run: |
          if [ ! -e /opt/procursus/bin/make ]; then
            sudo ln -s /opt/procursus/bin/gmake /opt/procursus/bin/make
          fi

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y autoconf automake autopoint bash bison cmake \
            docbook-xml docbook-xsl fakeroot findutils flex gawk git gnupg \
            groff gzip ldid libtool make meson ncurses-bin openssl patch pkg-config \
            po4a python3 sed tar triehash wget xz-utils zstd


      - name: Package Meson for iOS
        run: cd ${{ github.workspace }}; make meson-package MEMO_TARGET=iphoneos-arm64-roothide

      - name: Upload build_work archive
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build_work
          path: ${{ github.workspace }}/build_work/iphoneos-arm64-roothide/1800/
